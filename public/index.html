<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quill Image Uploader</title>
    <link
      href="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.snow.css"
      rel="stylesheet"
    />
    <style>
      #editor-1-container,
      #editor-2-container,
      #editor-3-container {
        height: 120px;
      }
    </style>
  </head>
  <body>
    <table width="100%">
      <tr>
        <td>
          <h5>Source Editor 1</h5>
          <div id="editor-1-container"></div>
        </td>
        <td>
          <h5>Source Editor 2</h5>
          <div id="editor-2-container"></div>
        </td>
      </tr>
    </table>
    <h1>&nbsp;</h1>
    <h5>Merged Target Editor</h5>
    <div id="editor-3-container"></div>
    <script src="https://cdn.jsdelivr.net/npm/quill@2/dist/quill.js"></script>
    <script>
      var quill1 = new Quill("#editor-1-container", {
        theme: "snow",
        modules: {
          toolbar: [
            ["bold", "italic"],
            ["link", "blockquote", "code-block", "image"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["table"],
          ],
          table: true,
        },
      });

      var quill2 = new Quill("#editor-2-container", {
        theme: "snow",
        modules: {
          toolbar: [
            ["bold", "italic"],
            ["link", "blockquote", "code-block", "image"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["table"],
          ],
          table: true,
        },
      });

      var quill3 = new Quill("#editor-3-container", {
        theme: "snow",
        modules: {
          toolbar: [
            ["bold", "italic"],
            ["link", "blockquote", "code-block", "image"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["table"],
          ],
          table: true,
        },
      });

      // Image upload handler
      function selectLocalImage(currentQuill) {
        const input = document.createElement("input");
        input.setAttribute("type", "file");
        input.setAttribute("accept", "image/*");
        input.click();
        input.onchange = () => {
          const file = input.files[0];
          if (/^image\//.test(file.type)) {
            saveToServer(file, currentQuill);
          } else {
            console.warn("You can only upload images.");
          }
        };
      }

      function saveToServer(file, currentQuill) {
        const fd = new FormData();
        fd.append("image", file);

        const xhr = new XMLHttpRequest();
        xhr.open("POST", "/upload", true);

        xhr.onload = () => {
          if (xhr.status === 200) {
            const url = JSON.parse(xhr.responseText).url;
            const range = currentQuill.getSelection();
            currentQuill.insertEmbed(range.index, "image", url);
          }
        };
        xhr.send(fd);
      }

      quill1.getModule("toolbar").addHandler("image", () => {
        selectLocalImage(quill1);
      });

      quill2.getModule("toolbar").addHandler("image", () => {
        selectLocalImage(quill2);
      });

      quill3.getModule("toolbar").addHandler("image", () => {
        selectLocalImage(quill3);
      });

      quill1.on("text-change", (delta, oldDelta, source) => {
        setTarget();
      });

      quill2.on("text-change", (delta, oldDelta, source) => {
        setTarget();
      });

      function setTarget() {
        var quill1Content = quill1.root.innerHTML.trim();
        var quill2Content = quill2.root.innerHTML.trim();
        quill3.root.innerHTML = quill1Content + "<hr>" + quill2Content;
      }
    </script>
  </body>
</html>
